name: Swift CI

on:
  workflow_call:
    secrets:
      PAT_TOKEN:
        required: false

permissions:
  contents: write # Required for creating releases and uploading assets
  checks: write
  pull-requests: write
  actions: read

jobs:

  swift:
    runs-on: macos-latest  # arm64 runner - kann cross-compile fÃ¼r x86_64
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive  # Wichtig fÃ¼r die C dependencies

      - name: Install CMake
        run: |
          if ! command -v cmake &> /dev/null; then
            echo "CMake not found, installing..."
            brew install cmake
          else
            echo "CMake already installed: $(cmake --version)"
          fi

      - name: Build iOS XCFramework (Device + Simulator)
        run: |
          echo "ðŸš€ Building iOS XCFramework for Device and Simulator..."
          echo "ðŸ’» Runner Architecture: $(uname -m)"
          echo "ðŸ”§ Xcode Version: $(xcodebuild -version)"
          
          # FÃ¼hre iOS Build aus
          cd bindings/swift
          chmod +x build_ios.sh
          ./build_ios.sh

      - name: Verify XCFramework
        run: |
          echo "ðŸ” Verifying iOS XCFramework..."
          XCFRAMEWORK_PATH="build_ios_arm/c4_swift.xcframework"
          
          # Start GitHub Step Summary
          echo "# ðŸ“¦ Swift iOS XCFramework Build Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ -d "$XCFRAMEWORK_PATH" ]]; then
            echo "âœ… iOS XCFramework found at: $XCFRAMEWORK_PATH"
            echo "## âœ… iOS XCFramework Successfully Created" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Zeige alle unterstÃ¼tzten Platformen
            echo "ðŸ“Š Supported platforms:"
            echo "### ðŸ—ï¸ Supported Platforms" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Platform | Architecture | Status |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------------|--------|" >> $GITHUB_STEP_SUMMARY
            
            find "$XCFRAMEWORK_PATH" -name "*.framework" -type d | while read framework; do
              platform=$(basename $(dirname "$framework"))
              binary="$framework/c4_swift"
              if [[ -f "$binary" ]]; then
                arch_info=$(file "$binary" | cut -d: -f2- | xargs)
                echo "  âœ… $platform: $arch_info"
                echo "| $platform | $arch_info | âœ… Built |" >> $GITHUB_STEP_SUMMARY
              else
                echo "  âŒ $platform: Binary not found"
                echo "| $platform | - | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
                exit 1
              fi
            done
            
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # PrÃ¼fe ob alle erwarteten iOS Platformen vorhanden sind
            echo "ðŸŽ¯ Checking for required iOS platforms..."
            echo "### ðŸŽ¯ iOS Platform Coverage" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            required_platforms=("ios-arm64" "ios-x86_64-simulator")
            platforms_found=0
            for platform in "${required_platforms[@]}"; do
              if [[ -d "$XCFRAMEWORK_PATH/$platform" ]]; then
                echo "  âœ… $platform: Found"
                echo "- âœ… **$platform**: Available" >> $GITHUB_STEP_SUMMARY
                ((platforms_found++))
              else
                echo "  âŒ $platform: Missing"
                echo "- âŒ **$platform**: Missing" >> $GITHUB_STEP_SUMMARY
              fi
            done
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**iOS Platform Coverage**: $platforms_found/2 platforms built successfully" >> $GITHUB_STEP_SUMMARY
            
            # Hinweis zu macOS
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ’» macOS Support" >> $GITHUB_STEP_SUMMARY
            echo "macOS static libraries are built separately due to XCFramework architecture conflicts." >> $GITHUB_STEP_SUMMARY
            echo "Use the macOS static libraries directly for macOS development." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # GrÃ¶ÃŸe anzeigen
            framework_size=$(du -sh "$XCFRAMEWORK_PATH" | cut -f1)
            echo "ðŸ“ XCFramework size: $framework_size"
            echo "### ðŸ“Š Build Statistics" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Framework Size**: $framework_size" >> $GITHUB_STEP_SUMMARY
            echo "- **Frameworks**: $(find "$XCFRAMEWORK_PATH" -name "*.framework" | wc -l | xargs)" >> $GITHUB_STEP_SUMMARY
            echo "- **Path**: \`$XCFRAMEWORK_PATH\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "ðŸ“ XCFramework structure:"
            find "$XCFRAMEWORK_PATH" -type d -maxdepth 2 | sort
          else
            echo "âŒ XCFramework not found!"
            echo "## âŒ XCFramework Build Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "XCFramework was not created at expected path: \`$XCFRAMEWORK_PATH\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Test Swift Package (macOS)
        run: |
          echo "ðŸ§ª Testing Swift Package on macOS..."
          cd bindings/swift
          
          # Add Swift test results to summary
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ§ª Swift Package Testing" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Baue macOS libraries fÃ¼r SPM tests
          echo "ðŸ”¨ Building macOS libraries for SPM..."
          echo "### ðŸ”¨ macOS Build" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          chmod +x build_macos.sh
          if ./build_macos.sh; then
            echo "âœ… macOS library build successful"
            echo "- âœ… **macOS Library Build**: Successful (arm64 + x86_64)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ macOS library build failed"
            echo "- âŒ **macOS Library Build**: Failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Swift Package Manager" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Teste Swift Package (ohne Server-abhÃ¤ngige Tests)
          echo "ðŸ“¦ Testing Swift Package..."
          echo "ðŸ“‹ Debug: Using static libs for macOS SPM"
          if swift build --verbose; then
            echo "âœ… Swift build successful"
            echo "- âœ… **Swift Build**: Successful" >> $GITHUB_STEP_SUMMARY
            
            # Show what was actually linked
            echo "ðŸ”— Built products:"
            find .build -name "*.dylib" -o -name "libColibri*" -o -name "*c4*" | head -5
          else
            echo "âŒ Swift build failed"
            echo "- âŒ **Swift Build**: Failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          # FÃ¼hre Tests aus und capture Ausgabe
          echo "ðŸ§ª Running Swift tests..."
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ§ª Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Capture test output
          if test_output=$(swift test 2>&1); then
            echo "âœ… Swift tests passed"
            echo "- âœ… **Swift Tests**: All tests passed" >> $GITHUB_STEP_SUMMARY
            
            # Extract test summary
            test_count=$(echo "$test_output" | grep -o "Executed [0-9]* tests" | tail -1 || echo "Tests executed")
            if [[ -n "$test_count" ]]; then
              echo "- ðŸ“Š **Test Summary**: $test_count" >> $GITHUB_STEP_SUMMARY
            fi
            
            # Extract performance info if available
            if echo "$test_output" | grep -q "getMethodSupport"; then
              echo "- ðŸš€ **Native C Integration**: Working (getMethodSupport tested)" >> $GITHUB_STEP_SUMMARY
            fi
            
            # Extract key test results
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "#### Test Details" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "$test_output" | grep -E "(âœ…|ðŸ“Š|ðŸ§ª)" | head -5 >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸  Swift tests had issues: $test_output"
            echo "- âš ï¸ **Swift Tests**: Had issues (may require server setup)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "#### Test Output" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "$test_output" | tail -10 >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Prepare iOS Distribution Package
        run: |
          echo "ðŸ“¦ iOS Distribution Package bereits durch build_ios.sh erstellt..."
          
          # Das build_ios.sh Script hat bereits den ios_package Ordner erstellt
          # Kopiere fÃ¼r CI-KompatibilitÃ¤t nach swift_package
          if [[ -d "bindings/swift/ios_package" ]]; then
            echo "ðŸ“‹ Kopiere ios_package nach swift_package fÃ¼r CI..."
            cp -r bindings/swift/ios_package swift_package
            
            echo "âœ… iOS Distribution Package bereit"
            
            # Add summary to GitHub Step Summary
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## ðŸ“¦ iOS Distribution Package" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **iOS-Only Package**: Ready for distribution" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“ **Artifact**: \`swift_package\` (copied from \`ios_package\`)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“‹ Package Contents" >> $GITHUB_STEP_SUMMARY
            echo "- iOS XCFramework (Device + Simulator only)" >> $GITHUB_STEP_SUMMARY
            echo "- Swift Sources and Tests" >> $GITHUB_STEP_SUMMARY  
            echo "- iOS-only Package.swift (no macOS conflicts)" >> $GITHUB_STEP_SUMMARY
            echo "- Integration documentation" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [[ -d "swift_package/c4_swift.xcframework" ]]; then
              framework_count=$(find swift_package/c4_swift.xcframework -name "*.framework" | wc -l | xargs)
              framework_size=$(du -sh swift_package/c4_swift.xcframework | cut -f1)
              echo "### ðŸ“Š XCFramework Details" >> $GITHUB_STEP_SUMMARY
              echo "- **Frameworks**: $framework_count (iOS only)" >> $GITHUB_STEP_SUMMARY
              echo "- **Total Size**: $framework_size" >> $GITHUB_STEP_SUMMARY
              echo "- **Ready for**: iOS Apps, Swift Package Manager" >> $GITHUB_STEP_SUMMARY
              echo "- **Local Development**: Use \`./build_ios.sh\` to create \`ios_package\`" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ ios_package nicht gefunden! build_ios.sh hat keinen ios_package erstellt."
            exit 1
          fi

      - name: Upload Swift Package
        uses: actions/upload-artifact@v4
        with:
          name: swift_package
          path: swift_package

      - name: Test iOS Integration Example
        run: |
          echo "ðŸ“± Testing iOS Integration Example..."
          cd bindings/swift/test_ios_app
          
          echo "ðŸ”¨ Building Test App for iOS Simulator..."
          echo "ðŸ“‹ Using iOS-only package (no macOS platform conflicts)"
          export SIMULATOR_SDK=$(xcrun --sdk iphonesimulator --show-sdk-path)
          echo "ðŸ“‹ iOS Simulator SDK: $SIMULATOR_SDK"
          
          # Build for iOS Simulator using explicit SDK and triple (forces correct platform)
          echo "ðŸ“‹ Explicit iOS Simulator SDK and triple to avoid macOS host platform..."
          if swift build --verbose \
            --sdk $SIMULATOR_SDK \
            --triple x86_64-apple-ios13.0-simulator 2>&1; then
            echo "âœ… Test App builds successfully"
            
            echo "ðŸ§ª Running Integration Tests on iOS Simulator..."
            if test_output=$(swift test --verbose \
              --sdk $SIMULATOR_SDK \
              --triple x86_64-apple-ios13.0-simulator 2>&1); then
              echo "âœ… Integration Tests passed"
              echo "- âœ… **iOS Integration**: All tests passed" >> $GITHUB_STEP_SUMMARY
            else
              echo "âš ï¸ Integration Tests had issues (may be expected in CI)"
              echo "- âš ï¸ **iOS Integration**: Tests had issues (expected in CI without blockchain state)" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "#### Test Output (Last 10 lines)" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              echo "$test_output" | tail -10 >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ Test App failed to build"
            echo "- âŒ **iOS Integration**: Build failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "ðŸ” Debug Information:"
            echo "ðŸ“Š Build Target Information:"
            echo "   - Host Platform: $(uname -m)"
            echo "   - iOS Simulator SDK: $SIMULATOR_SDK"
            echo "   - Swift Version: $(swift --version | head -1)"
            
            echo "ðŸ“Š iOS Package structure:"
            find ../ios_package -name "*.xcframework" -o -name "*.framework" -o -name "Package.swift" | head -10
            
            echo "ðŸ“Š XCFramework contents:"
            if [[ -d "../ios_package/c4_swift.xcframework" ]]; then
              echo "ðŸ“‹ XCFramework Info.plist:"
              cat ../ios_package/c4_swift.xcframework/Info.plist 2>/dev/null | head -20 || echo "No Info.plist"
              
              echo "ðŸ“‹ Available platforms:"
              ls -la ../ios_package/c4_swift.xcframework/ 2>/dev/null || echo "Cannot list platforms"
              
              echo "ðŸ“‹ Binary files:"
              find ../ios_package/c4_swift.xcframework -name "c4_swift" -exec file {} \; 2>/dev/null || echo "No binary found"
              
              echo "ðŸ“‹ Symbol check (first 5 matches):"
              find ../ios_package/c4_swift.xcframework -name "c4_swift" -exec nm -gU {} \; 2>/dev/null | grep -E "(c4_create_prover_ctx|buffer_append)" | head -5 || echo "Target symbols not found"
              
              echo "ðŸ“‹ All c4_ symbols (first 10):"
              find ../ios_package/c4_swift.xcframework -name "c4_swift" -exec nm -gU {} \; 2>/dev/null | grep "c4_" | head -10 || echo "No c4_ symbols found"
            else
              echo "âŒ XCFramework not found at ../ios_package/c4_swift.xcframework"
            fi
            
            echo "#### Build Error (Verbose Output)" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            # Get full verbose build error with explicit SDK and triple
            swift build --verbose --sdk $SIMULATOR_SDK --triple x86_64-apple-ios13.0-simulator 2>&1 | tail -50 >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "#### Debug Information" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "XCFramework structure:" >> $GITHUB_STEP_SUMMARY
            find ../ios_package -name "*.xcframework" -exec ls -la {} \; 2>/dev/null >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“± iOS Integration Test App" >> $GITHUB_STEP_SUMMARY
          echo "- **Purpose**: Integration testing + Developer example" >> $GITHUB_STEP_SUMMARY
          echo "- **Location**: \`bindings/swift/test_ios_app\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Documentation**: See test_ios_app/README.md" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY


      - name: Update Swift Package Repository
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          # Clone the Swift package repository
          git clone https://x-access-token:${{ secrets.PAT_TOKEN }}@github.com/corpus-core/colibri-stateless-swift.git

          # Copy updated files from ios_package (the canonical source)
          cp -r bindings/swift/ios_package/* colibri-stateless-swift/

          # Update version in Package.swift for release
          VERSION=${GITHUB_REF#refs/tags/v}
          cd colibri-stateless-swift

          # Configure git
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          # Commit and push changes
          git add .
          git commit -m "Release ${VERSION}"
          git tag "v${VERSION}"
          git push origin main --tags
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}

