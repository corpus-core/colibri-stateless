name: Swift CI

on:
  workflow_call:

jobs:

  swift:
    runs-on: macos-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Install CMake
        run: brew install cmake

      - name: Build x86_64 (Simulator)
        run: |
          xcrun --sdk iphonesimulator --show-sdk-path
          cmake -DSWIFT=true -DCMAKE_SYSTEM_NAME=iOS -DCMAKE_OSX_SYSROOT=$(xcrun --sdk iphonesimulator --show-sdk-path) -B build_x86 -DCMAKE_OSX_ARCHITECTURES=x86_64 -DCMAKE_OSX_DEPLOYMENT_TARGET=13.0 .
          cd build_x86
          make
          cd ..

      - name: Build arm64 (Device)
        run: |
          cmake -DSWIFT=true -DCMAKE_OSX_ARCHITECTURES=arm64 -DSWIFT_X86_BUILD=$(pwd)/build_x86 -B build .
          cd build
          make
          cd ..

      - name: Prepare Swift Package
        run: |
          mkdir -p swift_package
          cp -r bindings/swift/* swift_package/
          cp -r build/c4_swift.xcframework swift_package/
          rm -rf swift_package/CMakeLists.txt

      - name: Upload Swift Package
        uses: actions/upload-artifact@v4
        with:
          name: swift_package
          path: swift_package

      - name: Update Swift Package Repository
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          # Clone the Swift package repository
          git clone https://x-access-token:${{ secrets.PAT_TOKEN }}@github.com/corpus-core/colibri-stateless-swift.git

          # Copy updated files
          cp -r swift_package/* colibri-stateless-swift/

          # Update version in Package.swift for release
          VERSION=${GITHUB_REF#refs/tags/v}
          cd colibri-stateless-swift

          # Configure git
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          # Commit and push changes
          git add .
          git commit -m "Release ${VERSION}"
          git tag "v${VERSION}"
          git push origin main --tags
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}

