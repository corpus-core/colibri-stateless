name: Swift CI

on:
  workflow_call:

jobs:

  swift:
    runs-on: macos-latest  # arm64 runner - kann cross-compile fÃ¼r x86_64
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive  # Wichtig fÃ¼r die C dependencies

      - name: Install CMake
        run: brew install cmake

      - name: Build iOS XCFramework (Device + Simulator)
        run: |
          echo "ðŸš€ Building iOS XCFramework for Device and Simulator..."
          echo "ðŸ’» Runner Architecture: $(uname -m)"
          echo "ðŸ”§ Xcode Version: $(xcodebuild -version)"
          
          # FÃ¼hre iOS Build aus
          cd bindings/swift
          chmod +x build_ios.sh
          ./build_ios.sh

      - name: Verify XCFramework
        run: |
          echo "ðŸ” Verifying iOS XCFramework..."
          XCFRAMEWORK_PATH="build_ios_arm/c4_swift.xcframework"
          
          # Start GitHub Step Summary
          echo "# ðŸ“¦ Swift iOS XCFramework Build Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ -d "$XCFRAMEWORK_PATH" ]]; then
            echo "âœ… iOS XCFramework found at: $XCFRAMEWORK_PATH"
            echo "## âœ… iOS XCFramework Successfully Created" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Zeige alle unterstÃ¼tzten Platformen
            echo "ðŸ“Š Supported platforms:"
            echo "### ðŸ—ï¸ Supported Platforms" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Platform | Architecture | Status |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------------|--------|" >> $GITHUB_STEP_SUMMARY
            
            find "$XCFRAMEWORK_PATH" -name "*.framework" -type d | while read framework; do
              platform=$(basename $(dirname "$framework"))
              binary="$framework/c4_swift"
              if [[ -f "$binary" ]]; then
                arch_info=$(file "$binary" | cut -d: -f2- | xargs)
                echo "  âœ… $platform: $arch_info"
                echo "| $platform | $arch_info | âœ… Built |" >> $GITHUB_STEP_SUMMARY
              else
                echo "  âŒ $platform: Binary not found"
                echo "| $platform | - | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
                exit 1
              fi
            done
            
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # PrÃ¼fe ob alle erwarteten iOS Platformen vorhanden sind
            echo "ðŸŽ¯ Checking for required iOS platforms..."
            echo "### ðŸŽ¯ iOS Platform Coverage" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            required_platforms=("ios-arm64" "ios-x86_64-simulator")
            platforms_found=0
            for platform in "${required_platforms[@]}"; do
              if [[ -d "$XCFRAMEWORK_PATH/$platform" ]]; then
                echo "  âœ… $platform: Found"
                echo "- âœ… **$platform**: Available" >> $GITHUB_STEP_SUMMARY
                ((platforms_found++))
              else
                echo "  âŒ $platform: Missing"
                echo "- âŒ **$platform**: Missing" >> $GITHUB_STEP_SUMMARY
              fi
            done
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**iOS Platform Coverage**: $platforms_found/2 platforms built successfully" >> $GITHUB_STEP_SUMMARY
            
            # Hinweis zu macOS
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ’» macOS Support" >> $GITHUB_STEP_SUMMARY
            echo "macOS static libraries are built separately due to XCFramework architecture conflicts." >> $GITHUB_STEP_SUMMARY
            echo "Use the macOS static libraries directly for macOS development." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # GrÃ¶ÃŸe anzeigen
            framework_size=$(du -sh "$XCFRAMEWORK_PATH" | cut -f1)
            echo "ðŸ“ XCFramework size: $framework_size"
            echo "### ðŸ“Š Build Statistics" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Framework Size**: $framework_size" >> $GITHUB_STEP_SUMMARY
            echo "- **Frameworks**: $(find "$XCFRAMEWORK_PATH" -name "*.framework" | wc -l | xargs)" >> $GITHUB_STEP_SUMMARY
            echo "- **Path**: \`$XCFRAMEWORK_PATH\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "ðŸ“ XCFramework structure:"
            find "$XCFRAMEWORK_PATH" -type d -maxdepth 2 | sort
          else
            echo "âŒ XCFramework not found!"
            echo "## âŒ XCFramework Build Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "XCFramework was not created at expected path: \`$XCFRAMEWORK_PATH\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Test Swift Package (macOS)
        run: |
          echo "ðŸ§ª Testing Swift Package on macOS..."
          cd bindings/swift
          
          # Add Swift test results to summary
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ§ª Swift Package Testing" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Baue macOS libraries fÃ¼r SPM tests
          echo "ðŸ”¨ Building macOS libraries for SPM..."
          echo "### ðŸ”¨ macOS Build" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          chmod +x build_macos.sh
          if ./build_macos.sh; then
            echo "âœ… macOS library build successful"
            echo "- âœ… **macOS Library Build**: Successful (arm64 + x86_64)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ macOS library build failed"
            echo "- âŒ **macOS Library Build**: Failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Swift Package Manager" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Teste Swift Package (ohne Server-abhÃ¤ngige Tests)
          echo "ðŸ“¦ Testing Swift Package..."
          if swift build; then
            echo "âœ… Swift build successful"
            echo "- âœ… **Swift Build**: Successful" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Swift build failed"
            echo "- âŒ **Swift Build**: Failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          # FÃ¼hre Tests aus und capture Ausgabe
          echo "ðŸ§ª Running Swift tests..."
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ§ª Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Capture test output
          if test_output=$(swift test 2>&1); then
            echo "âœ… Swift tests passed"
            echo "- âœ… **Swift Tests**: All tests passed" >> $GITHUB_STEP_SUMMARY
            
            # Extract test summary
            test_count=$(echo "$test_output" | grep -o "Executed [0-9]* tests" | tail -1 || echo "Tests executed")
            if [[ -n "$test_count" ]]; then
              echo "- ðŸ“Š **Test Summary**: $test_count" >> $GITHUB_STEP_SUMMARY
            fi
            
            # Extract performance info if available
            if echo "$test_output" | grep -q "getMethodSupport"; then
              echo "- ðŸš€ **Native C Integration**: Working (getMethodSupport tested)" >> $GITHUB_STEP_SUMMARY
            fi
            
            # Extract key test results
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "#### Test Details" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "$test_output" | grep -E "(âœ…|ðŸ“Š|ðŸ§ª)" | head -5 >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸  Swift tests had issues: $test_output"
            echo "- âš ï¸ **Swift Tests**: Had issues (may require server setup)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "#### Test Output" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "$test_output" | tail -10 >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Prepare Swift Package
        run: |
          echo "ðŸ“¦ Preparing Swift Package for distribution..."
          mkdir -p swift_package
          
          # Kopiere Swift Package Dateien
          cp -r bindings/swift/Sources/ swift_package/
          cp -r bindings/swift/Tests/ swift_package/
          cp -r bindings/swift/xcframework/ swift_package/
          cp bindings/swift/README.md swift_package/ 2>/dev/null || echo "README.md not found, skipping"
          
          # Kopiere Universal XCFramework
          cp -r build_ios_arm/c4_swift.xcframework swift_package/
          
          # Erstelle Distribution Package.swift (mit binaryTarget fÃ¼r XCFramework)
          cat > swift_package/Package.swift << 'EOF'
          // swift-tools-version:5.3
          import PackageDescription
          
          let package = Package(
              name: "Colibri",
              platforms: [.iOS(.v13), .macOS(.v10_15)],
              products: [
                  .library(name: "Colibri", targets: ["Colibri"])
              ],
              targets: [
                  .binaryTarget(
                      name: "c4_swift",
                      path: "c4_swift.xcframework"
                  ),
                  .target(
                      name: "Colibri",
                      dependencies: ["c4_swift"],
                      path: "Sources/Colibri",
                      sources: ["Colibri.swift"]
                  ),
                  .testTarget(
                      name: "ColibriTests",
                      dependencies: ["Colibri"],
                      path: "Tests"
                  )
              ]
          )
          EOF
          
          # Erstelle ein README fÃ¼r die Distribution
          cat > swift_package/README.md << 'EOF'
          # Colibri Stateless Swift Package
          
          iOS XCFramework fÃ¼r native iOS App Integration.
          
          ## UnterstÃ¼tzte Platformen
          - ðŸ“± iOS (Device arm64 + Simulator x86_64)  
          
          ## macOS Support
          FÃ¼r macOS Entwicklung verwenden Sie die separaten static libraries oder die direkte SPM Integration.
          
          ## Integration
          
          ### iOS Xcode Projekt
          Drag & Drop `c4_swift.xcframework` in Ihr iOS Xcode Projekt.
          
          ### Swift Package Manager
          ```swift
          dependencies: [
              .package(url: "https://github.com/corpus-core/colibri-stateless-swift.git", from: "1.0.0")
          ]
          ```
          
          ## Verwendung
          ```swift
          import Colibri
          
          let client = Colibri(chainId: 1) // Ethereum Mainnet
          let support = client.getMethodSupport(method: "eth_getBalance")
          print("Method support: \(support)")
          ```
          EOF
          
          # Zeige Package-Inhalt
          echo "ðŸ“‹ Package contents:"
          find swift_package -type f \( -name "*.swift" -o -name "*.h" -o -name "Package.swift" -o -name "README.md" \) | sort
          
          echo "ðŸ“Š XCFramework info:"
          if [[ -d "swift_package/c4_swift.xcframework" ]]; then
            find swift_package/c4_swift.xcframework -name "*.framework" | wc -l | xargs echo "  Frameworks:"
            du -sh swift_package/c4_swift.xcframework | cut -f1 | xargs echo "  Size:"
          fi
          
          # Add final summary to GitHub Step Summary
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“¦ Distribution Package" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Swift Package**: Ready for distribution" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ **Artifact**: \`swift_package\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Package Contents" >> $GITHUB_STEP_SUMMARY
          echo "- iOS XCFramework (Device + Simulator)" >> $GITHUB_STEP_SUMMARY
          echo "- Swift Sources and Tests" >> $GITHUB_STEP_SUMMARY  
          echo "- Production-ready Package.swift" >> $GITHUB_STEP_SUMMARY
          echo "- Integration documentation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ -d "swift_package/c4_swift.xcframework" ]]; then
            framework_count=$(find swift_package/c4_swift.xcframework -name "*.framework" | wc -l | xargs)
            framework_size=$(du -sh swift_package/c4_swift.xcframework | cut -f1)
            echo "### ðŸ“Š XCFramework Details" >> $GITHUB_STEP_SUMMARY
            echo "- **Frameworks**: $framework_count (iOS only)" >> $GITHUB_STEP_SUMMARY
            echo "- **Total Size**: $framework_size" >> $GITHUB_STEP_SUMMARY
            echo "- **Ready for**: iOS Apps, Swift Package Manager" >> $GITHUB_STEP_SUMMARY
            echo "- **macOS**: Use static libraries or direct SPM integration" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Swift Package
        uses: actions/upload-artifact@v4
        with:
          name: swift_package
          path: swift_package

      - name: Update Swift Package Repository
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          # Clone the Swift package repository
          git clone https://x-access-token:${{ secrets.PAT_TOKEN }}@github.com/corpus-core/colibri-stateless-swift.git

          # Copy updated files
          cp -r swift_package/* colibri-stateless-swift/

          # Update version in Package.swift for release
          VERSION=${GITHUB_REF#refs/tags/v}
          cd colibri-stateless-swift

          # Configure git
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          # Commit and push changes
          git add .
          git commit -m "Release ${VERSION}"
          git tag "v${VERSION}"
          git push origin main --tags
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}

