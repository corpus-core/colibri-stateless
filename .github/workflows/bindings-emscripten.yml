name: Emscripten CI

on:
  workflow_call:
    inputs:
      enable_linux_arm64:
        description: "Run the linux-arm64 native addon prebuild job (requires a self-hosted runner with labels: self-hosted, linux, arm64)"
        required: false
        type: boolean
        default: false
    secrets:
      NPM_TOKEN:
        required: false

permissions:
  contents: write # Required for creating releases and uploading assets
  checks: write
  pull-requests: write
  actions: read

jobs:

  native_addon:
    name: Native addon prebuilds (${{ matrix.name }})
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: linux-x64
            runs_on: ubuntu-latest
            optional: false
          - name: macos-x64
            runs_on: macos-15-intel
            optional: false
          - name: macos-arm64
            runs_on: macos-latest
            optional: false
          - name: windows-x64
            runs_on: windows-latest
            optional: false
    runs-on: ${{ matrix.runs_on }}
    continue-on-error: ${{ matrix.optional }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Setup CMake
        uses: lukka/get-cmake@latest

      - name: Build libc4 shared library (SHAREDLIB=1)
        shell: bash
        run: |
          cmake -S . -B build/node-addon -DCMAKE_BUILD_TYPE=Release -DSHAREDLIB=1 -DCURL=0 -DCLI=0 -DUSE_MCL=1 -DMCL_MSVC_RUNTIME_DLL=ON
          cmake --build build/node-addon -j --config Release

      - name: Build node addon (node-gyp)
        shell: bash
        run: |
          cd bindings/node-addon
          npm install --no-audit --no-fund
          npx --yes node-gyp rebuild

      - name: Assemble prebuild folder
        shell: bash
        run: |
          PLATFORM="$(node -p "process.platform")"
          ARCH="$(node -p "process.arch")"
          OUT="prebuilds/${PLATFORM}-${ARCH}"
          mkdir -p "${OUT}"

          cp -f "bindings/node-addon/build/Release/colibri_native.node" "${OUT}/colibri_native.node"

          # Ship libc4 next to the addon so dlopen/LoadLibrary can resolve it.
          # On Windows the DLL often ends up under a config subdir (e.g. lib/Release/c4.dll),
          # so use find for robustness.
          find build/node-addon -maxdepth 5 -type f \( -name "*c4*.dylib" -o -name "*c4*.so*" -o -name "*c4*.dll" \) -print -exec cp -f {} "${OUT}/" \; || true

          echo "Prebuild output:"
          ls -la "${OUT}"

      - name: Smoke test native addon (loads libc4)
        shell: bash
        run: |
          # Ensure libc4 is next to the built .node for this smoke test.
          cp -f prebuilds/*-*/colibri_native.node bindings/node-addon/build/Release/colibri_native.node
          find prebuilds -type f \( -name "*c4*.dylib" -o -name "*c4*.so*" -o -name "*c4*.dll" \) -print -exec cp -f {} bindings/node-addon/build/Release/ \; || true
          node -e "const b=require('./bindings/node-addon/build/Release/colibri_native.node'); console.log('getMethodSupport=', b.getMethodSupport(1n,'eth_chainId'));"

      - name: Upload prebuilds
        uses: actions/upload-artifact@v4
        with:
          name: c4-native-${{ matrix.name }}
          path: prebuilds/**

  native_addon_linux_arm64:
    name: Native addon prebuilds (linux-arm64, self-hosted)
    if: ${{ inputs.enable_linux_arm64 }}
    runs-on: [self-hosted, linux, arm64]
    continue-on-error: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Setup CMake
        uses: lukka/get-cmake@latest

      - name: Build libc4 shared library (SHAREDLIB=1)
        shell: bash
        run: |
          cmake -S . -B build/node-addon -DCMAKE_BUILD_TYPE=Release -DSHAREDLIB=1 -DCURL=0 -DCLI=0 -DUSE_MCL=1
          cmake --build build/node-addon -j --config Release

      - name: Build node addon (node-gyp)
        shell: bash
        run: |
          cd bindings/node-addon
          npm install --no-audit --no-fund
          npx --yes node-gyp rebuild

      - name: Assemble prebuild folder
        shell: bash
        run: |
          PLATFORM="$(node -p "process.platform")"
          ARCH="$(node -p "process.arch")"
          OUT="prebuilds/${PLATFORM}-${ARCH}"
          mkdir -p "${OUT}"

          cp -f "bindings/node-addon/build/Release/colibri_native.node" "${OUT}/colibri_native.node"

          if compgen -G "build/node-addon/lib/*c4*.so*" > /dev/null; then
            cp -f build/node-addon/lib/*c4*.so* "${OUT}/"
          fi

          echo "Prebuild output:"
          ls -la "${OUT}"

      - name: Upload prebuilds
        uses: actions/upload-artifact@v4
        with:
          name: c4-native-linux-arm64
          path: prebuilds/**

  emscripten:
    needs: native_addon
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download native prebuilds
        uses: actions/download-artifact@v4
        with:
          pattern: c4-native-*
          path: native-prebuilds
          merge-multiple: true

      - name: Setup Emscripten
        uses: mymindstorm/setup-emsdk@v14
        with:
          version: 4.0.3

      - name: Build with Emscripten (Split WASM for npm)
        run: |
          emcmake cmake -B build -DWASM=true -DWASM_EMBED=OFF -DCLI=false -DTEST=false -DCURL=false -DCMAKE_BUILD_TYPE=MINSIZREL -DC4W_PREBUILDS_DIR="${GITHUB_WORKSPACE}/native-prebuilds" -S .
          cmake --build build

      - name: Run tests
        run: |
          cd bindings/emscripten
          npm test
          npm run test:node:native
          cd ../../

      - name: Create WASM Package
        run: |
          cd build/emscripten
          zip -r ../../colibri-wasm.zip ./*
          cd ../..

      - name: Upload WASM
        uses: actions/upload-artifact@v4
        with:
          name: c4-wasm
          path: colibri-wasm.zip

      - name: Set package version from tag
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          TAG_VERSION=${GITHUB_REF#refs/tags/v}
          echo "Setting version to $TAG_VERSION in package.json"
          npm version $TAG_VERSION --no-git-tag-version
        working-directory: build/emscripten

      - name: Publish to npm
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > ~/.npmrc
          npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        working-directory: build/emscripten
