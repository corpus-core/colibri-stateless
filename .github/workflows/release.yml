name: Release Creation

on:
  workflow_run:
    workflows: ["Main CI Pipeline"]
    types:
      - completed
    branches: [main, dev]

permissions:
  contents: write
  checks: read
  actions: read

jobs:
  check-workflows-and-tag:
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.check_release.outputs.should_release }}
      tag_name: ${{ steps.check_tag.outputs.tag_name }}
    steps:
      - name: Debug Workflow Info
        run: |
          echo "Workflow run ID: ${{ github.event.workflow_run.id }}"
          echo "Workflow name: ${{ github.event.workflow_run.name }}"
          echo "Head SHA: ${{ github.event.workflow_run.head_sha }}"
          echo "Head branch: ${{ github.event.workflow_run.head_branch }}"
          echo "Conclusion: ${{ github.event.workflow_run.conclusion }}"

      # Check if this is a tag commit and which workflows have run
      - name: Check workflows completion and tag
        id: check_release
        run: |
          # Only proceed if the triggering workflow succeeded
          if [[ "${{ github.event.workflow_run.conclusion }}" != "success" ]]; then
            echo "Triggering workflow did not succeed"
            echo "should_release=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Get head SHA for this run
          HEAD_SHA="${{ github.event.workflow_run.head_sha }}"
          echo "Commit SHA: $HEAD_SHA"

          # Check if Main CI Pipeline workflow has completed successfully for this SHA
          echo "Checking Main CI Pipeline workflow..."
          MAIN_CI_RUNS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/main-ci.yml/runs?status=completed&head_sha=$HEAD_SHA")

          MAIN_CI_SUCCESS=$(echo "$MAIN_CI_RUNS" | jq '.workflow_runs | map(select(.conclusion == "success")) | length')
          echo "Main CI Pipeline successful runs: $MAIN_CI_SUCCESS"

          # Check if this commit has any tags
          echo "Checking for tags..."
          TAGS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/git/refs/tags")

          # Find tags that point to this commit
          MATCHING_TAGS=$(echo "$TAGS" | jq -r ".[] | select(.object.sha == \"$HEAD_SHA\") | .ref" | sed 's|refs/tags/||')
          echo "Matching tags: $MATCHING_TAGS"

          # Make decision
          if [[ "$MAIN_CI_SUCCESS" -gt 0 && -n "$MATCHING_TAGS" ]]; then
            # Main CI Pipeline succeeded and there's at least one tag - proceed with release
            echo "Main CI Pipeline succeeded and tag found - should create release"
            echo "should_release=true" >> $GITHUB_OUTPUT
          else
            # Conditions not met - don't proceed
            echo "Not all conditions met for release:"
            echo "- Main CI Pipeline success: $MAIN_CI_SUCCESS (need > 0)"
            echo "- Tags found: $MATCHING_TAGS"
            echo "should_release=false" >> $GITHUB_OUTPUT
          fi

      - name: Find appropriate tag
        id: check_tag
        if: steps.check_release.outputs.should_release == 'true'
        run: |
          HEAD_SHA="${{ github.event.workflow_run.head_sha }}"

          # Fetch all tags that point to this commit
          TAGS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/git/refs/tags")

          # Find tags that point to this commit
          MATCHING_TAGS=$(echo "$TAGS" | jq -r ".[] | select(.object.sha == \"$HEAD_SHA\") | .ref" | sed 's|refs/tags/||')

          # Try to find a version tag first (starts with v)
          for TAG in $MATCHING_TAGS; do
            if [[ "$TAG" == v* ]]; then
              echo "Using version tag: $TAG"
              echo "tag_name=$TAG" >> $GITHUB_OUTPUT
              exit 0
            fi
          done

          # If no version tag found, use the first tag
          TAG=$(echo "$MATCHING_TAGS" | head -n 1)
          echo "No version tag found, using first tag: $TAG"
          echo "tag_name=$TAG" >> $GITHUB_OUTPUT

  create-release:
    needs: check-workflows-and-tag
    if: needs.check-workflows-and-tag.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Debug Info
        run: |
          echo "Creating release for tag: ${{ needs.check-workflows-and-tag.outputs.tag_name }}"

      # List available artifacts first for diagnostics
      - name: List Available CMake Artifacts
        run: |
          echo "Trigger commit SHA: ${{ github.event.workflow_run.head_sha }}"
          echo "Current workflow SHA: ${{ github.sha }}"
          echo "Listing available artifacts for CMake workflow..."
          # Get the workflow ID for cmake.yml
          WORKFLOW_ID=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/cmake.yml" | \
            jq -r '.id')
          echo "CMake workflow ID: $WORKFLOW_ID"

          # List all runs for this commit
          RUNS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/$WORKFLOW_ID/runs?head_sha=${{ github.event.workflow_run.head_sha }}")

          RUN_IDS=$(echo "$RUNS" | jq '.workflow_runs[].id')
          echo "Found runs with IDs: $RUN_IDS"

          # Check artifacts for each run
          for RUN_ID in $RUN_IDS; do
            echo "Checking artifacts for run $RUN_ID..."
            ARTIFACTS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/actions/runs/$RUN_ID/artifacts")
            
            ARTIFACT_COUNT=$(echo "$ARTIFACTS" | jq '.total_count')
            ARTIFACT_NAMES=$(echo "$ARTIFACTS" | jq -r '.artifacts[].name')
            
            echo "Found $ARTIFACT_COUNT artifacts: $ARTIFACT_NAMES"
          done

      # Download all artifacts from the Main CI Pipeline workflow
      - name: Download All Artifacts from Main CI
        uses: dawidd6/action-download-artifact@v6
        with:
          github_token: ${{secrets.GITHUB_TOKEN}}
          workflow: main-ci.yml
          workflow_conclusion: success
          commit: ${{github.event.workflow_run.head_sha}}
          path: artifacts

      - name: Prepare Release Files
        run: |
          echo "ðŸ“¦ Preparing release files from downloaded artifacts..."
          
          # Create release files directory
          mkdir -p release_files
          
          # List all downloaded artifacts for debugging
          echo "Downloaded artifacts structure:"
          find artifacts -type d | head -20
          
          # Count total files
          TOTAL_FILES=0
          
          # Process all artifact directories
          # Each artifact from main-ci.yml is in its own subdirectory
          for artifact_dir in artifacts/*; do
            if [ -d "$artifact_dir" ]; then
              artifact_name=$(basename "$artifact_dir")
              echo "Processing artifact: $artifact_name"
              
              # Handle different artifact types
              case "$artifact_name" in
                swift_package)
                  # Zip Swift package
                  cd "$artifact_dir"
                  zip -r ../../release_files/colibri-swift-package.zip ./*
                  cd ../..
                  if [ -f "release_files/colibri-swift-package.zip" ]; then
                    echo "  âœ… Added Swift package"
                    TOTAL_FILES=$((TOTAL_FILES+1))
                  fi
                  ;;
                  
                python-universal-distribution)
                  # Copy Python wheels
                  find "$artifact_dir" -name "*.whl" -exec cp {} release_files/ \;
                  WHEEL_COUNT=$(find release_files -name "*.whl" | wc -l)
                  if [ "$WHEEL_COUNT" -gt 0 ]; then
                    # Also create a zip of all wheels
                    WHEELS=$(find "$artifact_dir" -name "*.whl")
                    if [ -n "$WHEELS" ]; then
                      cd "$artifact_dir"
                      find . -name "*.whl" -exec zip ../../release_files/colibri-python-wheels.zip {} +
                      cd ../..
                    fi
                    echo "  âœ… Added $WHEEL_COUNT Python wheels"
                    TOTAL_FILES=$((TOTAL_FILES+WHEEL_COUNT+1))
                  fi
                  ;;
                  
                *-Release-*|cmake-release-*)
                  # Copy CMake release archives (pattern: os-latest-Release-compiler)
                  find "$artifact_dir" -type f \( -name "*.zip" -o -name "*.tar.gz" \) -exec cp {} release_files/ \;
                  CMAKE_FILES=$(find "$artifact_dir" -type f \( -name "*.zip" -o -name "*.tar.gz" \) | wc -l)
                  if [ "$CMAKE_FILES" -gt 0 ]; then
                    echo "  âœ… Added CMake build: $artifact_name ($CMAKE_FILES files)"
                    TOTAL_FILES=$((TOTAL_FILES+CMAKE_FILES))
                  fi
                  ;;
                  
                c4-wasm|colibri-aar|colibri-jar)
                  # Copy binding artifacts
                  find "$artifact_dir" -type f \( -name "*.zip" -o -name "*.aar" -o -name "*.jar" \) -exec cp {} release_files/ \;
                  echo "  âœ… Added: $artifact_name"
                  TOTAL_FILES=$((TOTAL_FILES+1))
                  ;;
                  
                debian-package|rpm-package|macos-package|windows-installer)
                  # Copy installer packages
                  find "$artifact_dir" -type f \( -name "*.deb" -o -name "*.rpm" -o -name "*.pkg" -o -name "*.msi" \) -exec cp {} release_files/ \;
                  INSTALLER_FILES=$(find release_files -type f \( -name "*.deb" -o -name "*.rpm" -o -name "*.pkg" -o -name "*.msi" \) | wc -l)
                  if [ "$INSTALLER_FILES" -gt 0 ]; then
                    echo "  âœ… Added installer: $artifact_name"
                    TOTAL_FILES=$((TOTAL_FILES+1))
                  fi
                  ;;
                  
                *)
                  echo "  âš ï¸  Skipping unknown artifact: $artifact_name"
                  ;;
              esac
            fi
          done
          
          # List all collected release files
          echo ""
          echo "ðŸ“‹ Collected release files ($TOTAL_FILES types):"
          ls -lh release_files/ | grep -v "^total" | awk '{print $9, "(" $5 ")"}'
          
          # Create a dummy file if no artifacts were found
          if [ "$TOTAL_FILES" -eq 0 ]; then
            echo "âš ï¸  WARNING: No artifacts were found for release. Creating a placeholder file."
            echo "This is a placeholder file. No artifacts were found for this release." > release_files/README.txt
          fi

      - name: Create Release
        id: create_release
        continue-on-error: true
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.check-workflows-and-tag.outputs.tag_name }}
          files: artifacts/release_files/*
          generate_release_notes: true
          draft: false
          body: |
            This release includes binaries and libraries for multiple platforms.

            ## Installation
            
            ### System Packages
            
            **Linux (Debian/Ubuntu):**
            ```bash
            sudo dpkg -i colibri-server_*.deb
            sudo apt-get install -f
            ```
            
            **Linux (RPM):**
            ```bash
            sudo rpm -ivh colibri-server-*.rpm
            ```
            
            **macOS (PKG):**
            ```bash
            sudo installer -pkg colibri-server-*.pkg -target /
            ```
            
            **macOS (Homebrew):**
            ```bash
            brew tap corpus-core/colibri
            brew install colibri-server
            brew services start colibri-server
            ```
            
            **Windows (MSI):**
            ```powershell
            msiexec /i colibri-server-*.msi
            ```
            
            ### Development Libraries
            
            **Python:**
            ```bash
            pip install colibri-stateless
            ```
            
            **Swift/iOS:** Download the Swift package artifact
            
            **JavaScript/WASM:** Download the c4-wasm artifact
            
            **Android/Kotlin:** Download the AAR or JAR artifact
            
            ## Included Artifacts
            
            - System installers (DEB, RPM, PKG, MSI)
            - CMake builds (Linux, macOS, Windows)
            - Swift package (iOS/macOS)
            - JavaScript/WASM package
            - Android AAR & JVM JAR
            - Python wheels
            
            If some artifacts are missing, they may not have been successfully built in the pipeline.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Summary
        if: always()
        run: |
          echo "## Release Creation Result" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.create_release.outcome }}" == "success" ]; then
            echo "âœ… Successfully created release for tag ${{ needs.check-workflows-and-tag.outputs.tag_name }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Failed to create release for tag ${{ needs.check-workflows-and-tag.outputs.tag_name }}" >> $GITHUB_STEP_SUMMARY
          fi

          echo "### Artifact Summary" >> $GITHUB_STEP_SUMMARY

          # Check all artifact types from main-ci.yml
          CMAKE_COUNT=$(find artifacts -type d -name "*-Release-*" -o -name "cmake-release-*" | wc -l)
          if [ "$CMAKE_COUNT" -gt 0 ]; then
            echo "- âœ… CMake artifacts: $CMAKE_COUNT builds" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ No CMake artifacts found" >> $GITHUB_STEP_SUMMARY
          fi

          SWIFT_COUNT=$(find artifacts/swift_package -type f 2>/dev/null | wc -l)
          if [ "$SWIFT_COUNT" -gt 0 ]; then
            echo "- âœ… Swift package: $SWIFT_COUNT files" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ No Swift package found" >> $GITHUB_STEP_SUMMARY
          fi

          WASM_COUNT=$(find artifacts/c4-wasm -name "*.zip" 2>/dev/null | wc -l)
          if [ "$WASM_COUNT" -gt 0 ]; then
            echo "- âœ… WASM package: $WASM_COUNT files" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ No WASM package found" >> $GITHUB_STEP_SUMMARY
          fi

          AAR_COUNT=$(find artifacts/colibri-aar -name "*.aar" 2>/dev/null | wc -l)
          if [ "$AAR_COUNT" -gt 0 ]; then
            echo "- âœ… AAR package: $AAR_COUNT files" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ No AAR package found" >> $GITHUB_STEP_SUMMARY
          fi

          JAR_COUNT=$(find artifacts/colibri-jar -name "*.jar" 2>/dev/null | wc -l)
          if [ "$JAR_COUNT" -gt 0 ]; then
            echo "- âœ… JAR package: $JAR_COUNT files" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ No JAR package found" >> $GITHUB_STEP_SUMMARY
          fi

          PYTHON_COUNT=$(find artifacts/python-universal-distribution -name "*.whl" 2>/dev/null | wc -l)
          if [ "$PYTHON_COUNT" -gt 0 ]; then
            echo "- âœ… Python wheels: $PYTHON_COUNT files" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ No Python wheels found" >> $GITHUB_STEP_SUMMARY
          fi

          DEB_COUNT=$(find artifacts/debian-package -name "*.deb" 2>/dev/null | wc -l)
          if [ "$DEB_COUNT" -gt 0 ]; then
            echo "- âœ… Debian packages: $DEB_COUNT files" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ No Debian packages found" >> $GITHUB_STEP_SUMMARY
          fi

          RPM_COUNT=$(find artifacts/rpm-package -name "*.rpm" 2>/dev/null | wc -l)
          if [ "$RPM_COUNT" -gt 0 ]; then
            echo "- âœ… RPM packages: $RPM_COUNT files" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ No RPM packages found" >> $GITHUB_STEP_SUMMARY
          fi

          PKG_COUNT=$(find artifacts/macos-package -name "*.pkg" 2>/dev/null | wc -l)
          if [ "$PKG_COUNT" -gt 0 ]; then
            echo "- âœ… macOS packages: $PKG_COUNT files" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ No macOS packages found" >> $GITHUB_STEP_SUMMARY
          fi

          MSI_COUNT=$(find artifacts/windows-installer -name "*.msi" 2>/dev/null | wc -l)
          if [ "$MSI_COUNT" -gt 0 ]; then
            echo "- âœ… Windows installers: $MSI_COUNT files" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ No Windows installers found" >> $GITHUB_STEP_SUMMARY
          fi
