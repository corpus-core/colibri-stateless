<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  
  <?define ProductName = "Colibri Server" ?>
  <?ifndef Version ?>
    <?define Version = "1.0.0.0" ?>
  <?endif?>
  <?define ProductVersion = "$(var.Version)" ?>
  <?define Manufacturer = "corpus.core" ?>
  <?define UpgradeCode = "12345678-1234-1234-1234-123456789ABC" ?>
  
  <Product Id="*" 
           Name="$(var.ProductName)" 
           Language="1033" 
           Version="$(var.ProductVersion)" 
           Manufacturer="$(var.Manufacturer)" 
           UpgradeCode="$(var.UpgradeCode)">
    
    <Package InstallerVersion="200" 
             Compressed="yes" 
             InstallScope="perMachine"
             Description="Colibri Stateless Prover Server for Ethereum"
             Comments="Trustless stateless-client for Ethereum and other L1/L2 networks"
             Manufacturer="corpus.core" />

    <!-- Add/Remove Programs metadata -->
    <Property Id="ARPURLINFOABOUT" Value="https://corpuscore.tech/" />
    <Property Id="ARPURLUPDATEINFO" Value="https://github.com/corpus-core/colibri-stateless/releases" />
    <Property Id="ARPCONTACT" Value="simon@corpus.io" />
    <Property Id="ARPCOMMENTS" Value="Ethereum stateless prover and verifier server - https://corpus-core.gitbook.io/specification-colibri-stateless" />
    
    <!-- Application Icon -->
    <Icon Id="ProductIcon" SourceFile="..\assets\c4_logo.ico" />
    <Property Id="ARPPRODUCTICON" Value="ProductIcon" />

    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />
    <MediaTemplate EmbedCab="yes" />

    <!-- Custom UI for configuration -->
    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />
    <UIRef Id="WixUI_InstallDir" />
    <UIRef Id="WixUI_ErrorProgressText" />

    <!-- Custom properties for user input -->
    <Property Id="SERVER_PORT" Value="8090" />
    <Property Id="CHAIN_ID" Value="1" />
    <Property Id="LOG_LEVEL" Value="0" />

    <!-- Directory structure -->
    <Directory Id="TARGETDIR" Name="SourceDir">
      <!-- Program Files (64-bit) -->
      <Directory Id="ProgramFiles64Folder">
        <Directory Id="INSTALLFOLDER" Name="Colibri">
          <!-- Server Binary -->
          <Component Id="MainExecutable" Guid="*" Win64="yes">
            <File Id="ColibriServerExe" 
                  Source="$(var.ServerExePath)" 
                  KeyPath="yes"
                  Name="colibri-server.exe" />
          </Component>
          
          <!-- CLI Tools -->
          <Component Id="CliProver" Guid="*" Win64="yes">
            <File Id="ColibriProverExe" 
                  Source="$(var.ProverExePath)" 
                  KeyPath="yes"
                  Name="colibri-prover.exe" />
          </Component>
          
          <Component Id="CliVerifier" Guid="*" Win64="yes">
            <File Id="ColibriVerifierExe" 
                  Source="$(var.VerifierExePath)" 
                  KeyPath="yes"
                  Name="colibri-verifier.exe" />
          </Component>
          
          <Component Id="CliSsz" Guid="*" Win64="yes">
            <File Id="ColibriSszExe" 
                  Source="$(var.SszExePath)" 
                  KeyPath="yes"
                  Name="colibri-ssz.exe" />
          </Component>
        </Directory>
      </Directory>

      <!-- ProgramData for config -->
      <Directory Id="CommonAppDataFolder">
        <Directory Id="ColibriDataFolder" Name="Colibri">
          <Component Id="ConfigFile" Guid="*" Win64="yes">
            <File Id="ServerConfig" 
                  Source="..\config\server.conf.default" 
                  Name="server.conf"
                  KeyPath="yes" />
            <!-- Note: Config placeholders should be replaced by installer script before packaging -->
          </Component>
        </Directory>
      </Directory>
    </Directory>

    <!-- Features -->
    <Feature Id="ProductFeature" Title="Colibri Server" Level="1">
      <ComponentRef Id="MainExecutable" />
      <ComponentRef Id="CliProver" />
      <ComponentRef Id="CliVerifier" />
      <ComponentRef Id="CliSsz" />
      <ComponentRef Id="ConfigFile" />
    </Feature>

    <!-- Custom actions for service installation -->
    <CustomAction Id="InstallService" 
                  Directory="INSTALLFOLDER" 
                  ExeCommand="[SystemFolder]sc.exe create ColibriServer binPath= &quot;[INSTALLFOLDER]colibri-server.exe -c [CommonAppDataFolder]Colibri\server.conf&quot; start= auto DisplayName= &quot;Colibri Stateless Server&quot;"
                  Execute="deferred"
                  Impersonate="no"
                  Return="ignore" />

    <CustomAction Id="StartService"
                  Directory="INSTALLFOLDER"
                  ExeCommand="[SystemFolder]sc.exe start ColibriServer"
                  Execute="deferred"
                  Impersonate="no"
                  Return="ignore" />

    <CustomAction Id="StopService"
                  Directory="INSTALLFOLDER"
                  ExeCommand="[SystemFolder]sc.exe stop ColibriServer"
                  Execute="deferred"
                  Impersonate="no"
                  Return="ignore" />

    <CustomAction Id="UninstallService"
                  Directory="INSTALLFOLDER"
                  ExeCommand="[SystemFolder]sc.exe delete ColibriServer"
                  Execute="deferred"
                  Impersonate="no"
                  Return="ignore" />

    <!-- Add firewall rule -->
    <CustomAction Id="AddFirewallRule"
                  Directory="INSTALLFOLDER"
                  ExeCommand="[SystemFolder]netsh.exe advfirewall firewall add rule name=&quot;Colibri Server&quot; dir=in action=allow protocol=TCP localport=[SERVER_PORT]"
                  Execute="deferred"
                  Impersonate="no"
                  Return="ignore" />

    <CustomAction Id="RemoveFirewallRule"
                  Directory="INSTALLFOLDER"
                  ExeCommand="[SystemFolder]netsh.exe advfirewall firewall delete rule name=&quot;Colibri Server&quot;"
                  Execute="deferred"
                  Impersonate="no"
                  Return="ignore" />

    <!-- Installation sequence -->
    <InstallExecuteSequence>
      <Custom Action="InstallService" After="InstallFiles">NOT Installed</Custom>
      <Custom Action="AddFirewallRule" After="InstallService">NOT Installed</Custom>
      <Custom Action="StartService" After="AddFirewallRule">NOT Installed</Custom>
      
      <Custom Action="StopService" Before="RemoveFiles">Installed AND NOT UPGRADINGPRODUCTCODE</Custom>
      <Custom Action="UninstallService" After="StopService">Installed AND NOT UPGRADINGPRODUCTCODE</Custom>
      <Custom Action="RemoveFirewallRule" After="UninstallService">Installed AND NOT UPGRADINGPRODUCTCODE</Custom>
    </InstallExecuteSequence>

  </Product>
</Wix>

